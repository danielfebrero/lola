import os
import subprocess

def copy_file_with_dd(source, destination):
    """Utilise dd pour copier un fichier."""
    try:
        subprocess.run(["dd", f"if={source}", f"of={destination}", "bs=4M", "status=progress"], check=True)
        print(f"Successfully copied {source} to {destination}")
    except subprocess.CalledProcessError as e:
        print(f"Error copying {source} to {destination}: {e}")

def copy_directory_with_dd(source_dir, destination_dir):
    """Copie les fichiers d'un répertoire source vers un répertoire de destination en utilisant dd."""
    if not os.path.exists(destination_dir):
        os.makedirs(destination_dir)

    for root, dirs, files in os.walk(source_dir):
        for file in files:
            source_file = os.path.join(root, file)
            destination_file = os.path.join(destination_dir, os.path.relpath(source_file, source_dir))
            destination_file_dir = os.path.dirname(destination_file)
            
            if not os.path.exists(destination_file_dir):
                os.makedirs(destination_file_dir)
            
            copy_file_with_dd(source_file, destination_file)

if __name__ == "__main__":
    source_directory = "/etc"  # Répertoire source dans le système de fichiers root
    destination_directory = "/mnt/data/etc_copy"  # Répertoire de destination dans le sandbox

    # Copier le répertoire source vers le répertoire de destination en utilisant dd
    copy_directory_with_dd(source_directory, destination_directory)
    print("Copie du répertoire terminée.")
