;; Copyright (c) 2012 Apple Inc.  All Rights reserved.
;;
;; WARNING: The sandbox rules in this file currently constitute
;; Apple System Private Interface and are subject to change at any time and
;; without notice. The contents of this file are also auto-generated and not
;; user editable; it may be overwritten at any time.
;;

(version 1)
(deny default)

(import "system.sb")
(import "com.apple.corefoundation.sb")

(allow pseudo-tty)

(allow file-ioctl
    (literal "/dev/ptmx")
    (regex #"^/dev/ttys")
)

(allow file-read* file-write*
    (regex #"^/Library/Keychains/System.keychain")
    (regex #"^/Library/Keychains[^/]+\.[^/]+$")
    (literal "/Library/Keychains")
    (literal "/dev/ptmx")
    (regex #"^/dev/ttys")
)

(allow file-read* file-write*
    (regex #"^/private/var/root/Library/Logs/Bluetooth/[^/]+\.pklg$")
    (literal "/private/var/root/Library/Logs")
    (literal "/private/var/root/Library/Logs/Bluetooth")
    (literal "/private/var/root/Library/Preferences/com.apple.BTServer.plist")
    (literal "/private/var/root/Library/Preferences/com.apple.CoreBluetooth.cloud.plist")
)

(allow file-read-data
    (subpath "/System/Library/CoreServices")
    (literal "/private/var/db/mds/system/mdsObject.db")
    (literal "/Library/Managed Preferences/local/.GlobalPreferences.plist")
)

(allow file-issue-extension
  (extension-class "com.apple.cfprefsd.read")
  (extension-class "com.apple.cfprefsd.read-write")
  (subpath "/Library/Bluetooth/Library/Preferences")
)


(allow distributed-notification-post)

(allow mach-per-user-lookup)
(allow mach-lookup
(global-name "com.apple.accessories.transport-server")
(global-name "com.apple.distributed_notifications@1v3")
(global-name "com.apple.CoreServices.coreservicesd")
(global-name "com.apple.bluetoothUIServer")
(global-name "com.apple.bluetoothuserd")
(global-name "com.apple.cloudpaird")
(global-name "com.apple.bluetooth.cloudkit.xpc")
(global-name "com.apple.BTServer.avrcp")
(global-name "com.apple.BTServer.cloudpairing")
(global-name "com.apple.BTServer.le")
(global-name "com.apple.BTServer.le.agent")
(global-name "com.apple.bluetoothaudiod")
(global-name "com.apple.bnepd")
(global-name "com.apple.blued")
(global-name "com.apple.bluetoothd")
(global-name "com.apple.bluetooth.nsxpc")
(global-name "com.apple.bluetooth.magnet.shm")
(global-name "com.apple.server.bluetooth.le.pipe.xpc")
(global-name "com.apple.server.bluetooth.le.att.xpc")
(global-name "com.apple.server.bluetooth.general.xpc")
(global-name "com.apple.airportd")
(global-name "com.apple.BluetoothDOServer")
(global-name "com.apple.SystemConfiguration.configd")
(global-name "com.apple.SecurityServer")
(global-name "com.apple.btsa")
(global-name "com.apple.bluetoothaudiod")
(global-name "com.apple.lsd.mapdb")
(global-name "com.apple.iohideventsystem")
(global-name "com.apple.bluetoothReporter")
(global-name "com.apple.PowerManagement.control")
(global-name "com.apple.mediaremoted.xpc")
(global-name "com.apple.awdd")
(global-name "com.apple.analyticsd")
(global-name "com.apple.wifi.sharekitSandbox")
(global-name "com.apple.corewlan-xpc")
(global-name "com.apple.private.corewifi-xpc")
(global-name "com.apple.iokit.powerdxpc")
(global-name "com.apple.usernoted.daemon_client")
(global-name "com.apple.tccd.system")
(global-name "com.apple.icloud.searchpartyd.beaconmanager")
(global-name "com.apple.analyticsd.messagetracer")
(global-name "com.apple.icloud.searchpartyuseragent.beaconmanager")
(global-name "com.apple.ocspd")
(global-name "com.apple.telephonyutilities.callservicesdaemon.callcapabilities")
(global-name "com.apple.telephonyutilities.callservicesdaemon.callstatecontroller")
(global-name "com.apple.commcenter.coretelephony.xpc")
(global-name "com.apple.icloud.searchpartyuseragent.beaconmanager")
(global-name "com.apple.audio.AudioComponentRegistrar")
(global-name "com.apple.audio.audiohald")
(global-name "com.apple.audio.coreaudiod")
(global-name "com.apple.server.bluetooth")
(global-name "com.apple.BlueTool")
(global-name "com.apple.tccd")
(global-name "com.apple.powerlog.plxpclogger.xpc")
(global-name "com.apple.rapport")
(global-name "com.apple.runningboard.process-state")
(global-name "com.apple.BluetoothCloudServices")
(global-name "com.apple.BluetoothServices")
(global-name "com.apple.bluetoothuser.xpc")
(global-name "com.apple.windowserver.active")
(global-name "com.apple.NetworkSharing")
(global-name "com.apple.osanalytics.osanalyticshelper")
(global-name "com.apple.WirelessCoexManager")
(global-name "com.apple.timesync.expositor")
(global-name "com.apple.timesync.manager")
(global-name "com.apple.timesync.ptp.manager")
(global-name "com.apple.searchparty.managedperipheral")
(global-name "com.apple.DiagnosticExtensions.BluetoothHeadset")
(global-name "com.apple.symptom_diagnostics")
(global-name "com.apple.findmy.LocalBeaconing")
(global-name "com.apple.biome.access.system")
(global-name "com.apple.mobile.keybagd.UserManager.xpc")
(global-name "com.apple.timed.xpc")
(global-name "com.apple.matter.support.xpc")
)

(allow mach-register
    (global-name "com.apple.BTServer.cloudpairing")
    (global-name "com.apple.IOUserBluetoothSerialManager")
)

(allow file-write-create
(regex   #"^/private/var/log/bluetoothCoreDump-[^/]+\.log$")
(regex   #"^/private/var/log/Accessory[^/]+\.[^/]+$")
(regex   #"^/private/var/log/bluetooth[^/]+\.log$")
(literal "/private/var/log/cloudpaird.log")
(literal "/Library/Bluetooth")
(literal "/Library/Bluetooth/Library")
(literal "/Library/Bluetooth/Library/Preferences")
(literal "/Library/Bluetooth/Library/Preferences/com.apple.MobileBluetooth.devices.plist")
)

(allow file-read* file-write*
(literal "/private/var/root/Library/Preferences/com.apple.bluetoothd.plist")
(literal "/private/var/root/Library/Preferences/com.apple.MobileBluetooth.debug.plist")
(literal "/private/var/root/Library/Preferences/blued.plist")
(literal "/private/var/root/Library/Preferences/com.apple.blued.plist")

(regex   #"^/private/var/root/Library/Preferences/ByHost/com\.apple\.bluetoothd\.[^/]+\.plist$")
(regex   #"^/private/var/root/Library/Preferences/ByHost/com\.apple\.blued\.[^/]+\.plist$")
(regex   #"^/private/var/root/Library/Preferences/ByHost/\.GlobalPreferences\.[^/]+\.plist$")
(regex   #"^/private/var/root/Library/Preferences/ByHost/com\.apple\.Bluetooth\.[^/]+\.plist$")

(regex   #"^/Library/Preferences/com\.apple\.Bluetooth\.plist")
(literal "/private/tmp/com.apple.Bluetooth.plist")

(literal "/dev/io8log")
(literal "/dev/io8logtemp")

(regex   #"^/private/var/log/bluetoothCoreDump-[^/]+\.log$")
(regex   #"^/private/var/log/Accessory[^/]+\.[^/]+$")
(regex   #"^/private/var/log/bluetooth[^/]+\.log$")
(literal "/private/var/log/cloudpaird.log")

(literal "/Library/Preferences/SystemConfiguration/com.apple.Bluetooth")
(literal "/Library/Preferences/SystemConfiguration/com.apple.Bluetooth-lock")
(literal "/Library/Preferences/SystemConfiguration/com.apple.Bluetooth-new")

)

(allow file-read*
(literal "/Library/Preferences/SystemConfiguration/preferences.plist")

(literal "/private/var/root/Library/Preferences/.GlobalPreferences.plist")

(literal "/Library/Preferences/.GlobalPreferences.plist")

(literal "/AppleInternal")
(literal "/usr/sbin")
(literal "/usr/sbin/bluetoothd")
(literal "/private/var/root")
(literal "/dev/console")
(literal "/private/var/log")
(literal "/private/var/log/Bluetooth")
(literal "/private/var/db/.AppleSetupDone")
(literal "/Library/Preferences/SystemConfiguration/com.apple.nat.plist")
(literal "/private/var/root/FWfile.bin")

(literal "/private/etc/bluetool")
(regex #"^/private/etc/bluetool/[^/]+\.bin$")
(regex #"^/private/etc/bluetool/[^/]+\.ptb$")
)

(allow ipc-posix-shm
(ipc-posix-name "apple.shm.notification_center")
(ipc-posix-name "com.apple.bluetooth.magnet.shm")
(ipc-posix-name-regex #"^/tmp/com.apple.csseed.[0-9]+$")
)

(allow iokit-open
(iokit-user-client-class "IOBluetoothDeviceUserClient")
(iokit-user-client-class "IOHIDResourceDeviceUserClient")
(iokit-user-client-class "IOBluetoothHCIUserClient")
(iokit-user-client-class "IOBluetoothL2CAPChannelUserClient")
(iokit-user-client-class "IOHIDLibUserClient")
(iokit-user-client-class "RootDomainUserClient")
(iokit-user-client-class "AppleBluetoothModuleUserClient")
(iokit-user-client-class "AppleConvergedIPCUserClient")
(iokit-user-client-class "AppleKeyStoreUserClient")
(iokit-user-client-class "AppleUSBHostDeviceUserClient")
(iokit-user-client-class "BTDebugUserClient")
(iokit-user-client-class "IOUSBDeviceUserClientV2")
(iokit-user-client-class "IOUSBInterfaceUserClientV3")
(iokit-user-client-class "IOUserUserClient")
(iokit-user-client-class "IOUserBluetoothSerialClient")
(iokit-user-client-class "IOUserEthernetResourceUserClient")
(iokit-user-client-class "IOTimeSyncClockManagerUserClient")
(iokit-user-client-class "IOTimeSyncUserFilteredServiceUserClient")
(iokit-user-client-class "AppleTrustedAccessoryManagerUserClient")
)

(allow network-outbound)

(allow file-read-data
(literal "/usr/local/lib/libAudioDiagnostics.dylib")
(literal "/private/var/root/Library/Preferences/.GlobalPreferences.plist")
(literal "/Library/Preferences/.GlobalPreferences.plist")
(literal "/Library/Preferences/com.apple.security.plist")
(regex #"^/Library/Keychains/.*")
(literal "/Library/Bluetooth")
(literal "/Library/Bluetooth/Library")
(literal "/Library/Bluetooth/Library/Preferences")
(literal "/Library/Bluetooth/Library/Preferences/com.apple.MobileBluetooth.devices.plist")
(literal "/private/var/db")
(regex #"^/Library/Application Support/BTServer/.*")
)

(allow file-write-create file-write-unlink
(literal "/private/tmp/hci.pklg")
(regex #"^/Library/Keychains/")
)

(allow network-outbound
(literal "/private/var/run/systemkeychaincheck.socket")
(literal "/private/var/run/mDNSResponder")
)

(allow file-read-metadata
(literal "/Library/Keychains/System.keychain")
(regex #"^/private/var/db/mds/.*")
(literal "/Library")
(literal "/")
(literal "/private")
(literal "/private/var")
(literal "/private/var/db")
(literal "/private/var/root")
(literal "/private/var/root/systemkeychaincheck.done")
(literal "/private/var/run/systemkeychaincheck.done")
(literal "/Library/Keychains")
(literal "/Library/Preferences/com.apple.security.plist")
(literal "/Library/Security/Trust Settings/Admin.plist")
(regex #"^/Library/Keychains/.*")
(literal "/Library/DriverExtensions")
(literal "/AppleInternal/Library/Extensions")
(literal "/usr")
(literal "/usr/local/lib/libAudioDiagnostics.dylib")
(regex #"^/Library/Application Support/BTServer/.*")
(regex #"^/usr/share/icu/")
(regex #"^/Library/Preferences/")
(regex #"^/private/var/root/Library/Preferences/")
)

(allow file-read* file-write-mode (regex #"^/Library/Keychains/*"))

(allow file-write*
(literal "/Library/Keychains/System.keychain")
(literal "/private/var/db/mds/system/mds.lock")
(literal "/private/tmp/hci.pklg")
(literal "/Library/Bluetooth/Library/Preferences/com.apple.MobileBluetooth.devices.plist")
(regex "^/Library/Preferences/SystemConfiguration/")
)

(allow file-read-data
(regex #"^/private/var/db/mds(/.*)?")
(literal "/")
(literal "/Library/Preferences/SystemConfiguration/NetworkInterfaces.plist")
(literal "/Library/Preferences/SystemConfiguration/preferences.plist")
)

(allow iokit-set-properties)

(allow system-socket)

(allow user-preference-read
(preference-domain "com.apple.bluetooth")
(preference-domain "com.apple.Bluetooth")
(preference-domain "com.apple.icloud.searchpartyd")
(preference-domain "com.apple.icloud.searchpartyd.mac-beacon")
(preference-domain "com.apple.MobileBluetooth.debug")
(literal "/Library/Preferences/SystemConfiguration/NetworkInterfaces.plist")
(literal "/Library/Preferences/SystemConfiguration/preferences.plist")
)
(allow user-preference-write
(preference-domain "com.apple.bluetooth")
(preference-domain "com.apple.Bluetooth")
(literal "/Library/Preferences/SystemConfiguration/NetworkInterfaces.plist")
(literal "/Library/Preferences/SystemConfiguration/preferences.plist")
)

(allow file-write-data
(literal "/private/var/root/Library/Preferences/com.apple.BTServer.plist")
(literal "/Library/Preferences/SystemConfiguration/NetworkInterfaces.plist")
(literal "/Library/Preferences/SystemConfiguration/preferences.plist")
)

(allow file-read* file-write-data file-ioctl
(literal "/dev/uart.log"))

(allow file-read* file-write-data file-ioctl
(literal "/dev/cu.BLTH"))

(allow system-privilege)

(allow authorization-right-obtain
    (right-name "com.apple.PacketLogger.HCI"))
